{% extends "base.html" %}
{% block title %}Web Camera Scanner{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="text-primary">Web Camera Scanner</h1>
        <p class="text-muted">Scan student ID barcode/QR code</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Camera Scanner</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div id="reader" style="width: 100%; height: 400px;"></div>
                    
                    <div class="mt-3">
                        <button id="startScanner" class="btn btn-primary">
                            Start Scanner
                        </button>
                        <button id="stopScanner" class="btn btn-danger" style="display: none;">
                            Stop Scanner
                        </button>
                    </div>
                    
                    <div id="scanResult" class="alert alert-success mt-3" style="display: none;">
                        <h5>Student Found!</h5>
                        <p id="resultText"></p>
                        <a id="evaluateLink" href="#" class="btn btn-success">
                            Proceed to Evaluate
                        </a>
                    </div>
                    
                    <div id="scanError" class="alert alert-danger mt-3" style="display: none;">
                        <h5>Scanning Error</h5>
                        <p>Please enter the Student ID manually.</p>
                        <a href="{{ url_for('staff_evaluate') }}" class="btn btn-primary">
                            Manual Entry
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Scanner Guide</h5>
            </div>
            <div class="card-body">
                <h6>How to scan:</h6>
                <ol class="small">
                    <li>Click "Start Scanner"</li>
                    <li>Allow camera access</li>
                    <li>Position barcode/QR in frame</li>
                    <li>It will scan automatically</li>
                </ol>
                
                <h6 class="mt-3">Tips:</h6>
                <ul class="small">
                    <li>Ensure good lighting</li>
                    <li>Hold steady</li>
                    <li>Center the code</li>
                    <li>Use back camera for phones</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <strong>Note:</strong> If scanning doesn't work, use manual entry.
                </div>
                
                <a href="{{ url_for('staff_evaluate') }}" class="btn btn-primary w-100 mt-2">
                    Manual Entry
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include HTML5-QRCode library -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
let html5QrCode = null;

document.getElementById('startScanner').addEventListener('click', function() {
    const startBtn = document.getElementById('startScanner');
    const stopBtn = document.getElementById('stopScanner');
    
    html5QrCode = new Html5Qrcode("reader");
    
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Stop scanning
        html5QrCode.stop().then(() => {
            // Show result
            document.getElementById('scanResult').style.display = 'block';
            document.getElementById('resultText').innerHTML = 
                `<strong>Student ID:</strong> ${decodedText}`;
            document.getElementById('evaluateLink').href = 
                `/staff/evaluate?student_id=${decodedText}`;
            
            // Hide buttons
            startBtn.style.display = 'none';
            stopBtn.style.display = 'none';
        });
    };
    
    const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 } 
    };
    
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
    ).catch(err => {
        console.error(err);
        document.getElementById('scanError').style.display = 'block';
    });
    
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
});

document.getElementById('stopScanner').addEventListener('click', function() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById('startScanner').style.display = 'inline-block';
            document.getElementById('stopScanner').style.display = 'none';
        });
    }
});
</script>
{% endblock %}